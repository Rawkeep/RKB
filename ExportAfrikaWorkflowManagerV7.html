<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Export Afrika Workflow Manager V7</title>
<style>
:root {
  --primary: #1a5276;
  --primary-light: #2980b9;
  --secondary: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
  --dark: #2c3e50;
  --light: #ecf0f1;
  --bg: #f5f7fa;
  --card: #ffffff;
  --text: #333;
  --text-light: #7f8c8d;
  --border: #ddd;
  --sidebar-width: 260px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }
.sidebar {
  width: var(--sidebar-width); background: var(--dark); color: #fff; padding: 0;
  position: fixed; top:0; left:0; bottom:0; overflow-y: auto; z-index: 100;
  transition: transform .3s;
}
.sidebar-header { padding: 20px; background: var(--primary); text-align: center; }
.sidebar-header h2 { font-size: 16px; font-weight: 600; }
.sidebar-header small { opacity: .7; font-size: 11px; }
.nav-section { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,.1); }
.nav-section-title { padding: 5px 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: .5; }
.nav-item {
  display: flex; align-items: center; padding: 10px 20px; cursor: pointer;
  transition: background .2s; font-size: 13px; gap: 10px;
}
.nav-item:hover { background: rgba(255,255,255,.1); }
.nav-item.active { background: var(--primary); border-left: 3px solid var(--secondary); }
.nav-badge {
  margin-left: auto; background: var(--danger); color: #fff; border-radius: 10px;
  padding: 1px 7px; font-size: 10px; min-width: 18px; text-align: center;
}
.nav-badge.green { background: var(--secondary); }
.nav-badge.orange { background: var(--warning); }
.main { margin-left: var(--sidebar-width); flex:1; padding: 20px; }
.topbar {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
}
.topbar h1 { font-size: 22px; color: var(--primary); }
.btn {
  padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 13px; font-weight: 500; transition: all .2s; display: inline-flex;
  align-items: center; gap: 6px;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-light); }
.btn-success { background: var(--secondary); color: #fff; }
.btn-success:hover { background: #219a52; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-sm { padding: 5px 10px; font-size: 11px; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { background: var(--light); }
.stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 15px; margin-bottom: 20px; }
.stat-card {
  background: var(--card); border-radius: 10px; padding: 18px; box-shadow: 0 2px 8px rgba(0,0,0,.06);
  border-left: 4px solid var(--primary);
}
.stat-card.green { border-left-color: var(--secondary); }
.stat-card.orange { border-left-color: var(--warning); }
.stat-card.red { border-left-color: var(--danger); }
.stat-card .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
.stat-card .stat-label { font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; }
.card {
  background: var(--card); border-radius: 10px; padding: 20px; margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--primary); }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th { background: var(--light); padding: 10px 8px; text-align: left; font-weight: 600; color: var(--primary); white-space: nowrap; }
td { padding: 8px; border-bottom: 1px solid #eee; }
tr:hover { background: #f8f9fa; }
.status-badge {
  display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px;
  font-weight: 500; white-space: nowrap;
}
.status-new { background: #e8f5e9; color: #2e7d32; }
.status-inprogress { background: #fff3e0; color: #ef6c00; }
.status-completed { background: #e3f2fd; color: #1565c0; }
.status-shipped { background: #f3e5f5; color: #7b1fa2; }
.status-delivered { background: #e0f2f1; color: #00695c; }
.status-delayed { background: #ffebee; color: #c62828; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
.risk-low { color: var(--secondary); font-weight: 600; }
.risk-medium { color: var(--warning); font-weight: 600; }
.risk-high { color: var(--danger); font-weight: 600; }
.modal-overlay {
  display: none; position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,.5); z-index: 200; justify-content: center; align-items: flex-start;
  padding: 40px 20px; overflow-y: auto;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff; border-radius: 12px; padding: 25px; width: 100%; max-width: 700px;
  max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,.2);
}
.modal h3 { margin-bottom: 20px; color: var(--primary); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: var(--text-light); }
.form-group input, .form-group select, .form-group textarea {
  width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; font-family: inherit;
}
.form-group textarea { min-height: 80px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
.tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
.tab {
  padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px;
  background: var(--light); border: none; transition: all .2s;
}
.tab.active { background: var(--primary); color: #fff; }
.search-box {
  padding: 8px 14px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; width: 250px;
}
.notification-list { max-height: 300px; overflow-y: auto; }
.notification-item {
  padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: flex-start;
}
.notification-item.unread { background: #f0f7ff; }
.notif-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); margin-top: 4px; flex-shrink: 0; }
.bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 120px; padding-top: 10px; }
.bar-item { display: flex; flex-direction: column; align-items: center; flex:1; }
.bar {
  width: 100%; min-width: 30px; background: var(--primary-light); border-radius: 4px 4px 0 0;
  transition: height .5s;
}
.bar-label { font-size: 9px; color: var(--text-light); margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px; }
.bar-value { font-size: 10px; font-weight: 600; margin-bottom: 2px; }
.email-template {
  background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px;
  padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all .2s;
}
.email-template:hover { border-color: var(--primary); background: #f0f7ff; }
.email-template h4 { font-size: 13px; color: var(--primary); margin-bottom: 5px; }
.email-template p { font-size: 11px; color: var(--text-light); }
.copy-feedback {
  position: fixed; top: 20px; right: 20px; background: var(--secondary); color: #fff;
  padding: 10px 20px; border-radius: 8px; z-index: 999; display: none; font-size: 13px;
}
.hidden { display: none !important; }
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; }
  .form-row, .form-row-3 { grid-template-columns: 1fr; }
  .stat-cards { grid-template-columns: 1fr 1fr; }
}
.menu-toggle {
  display: none; position: fixed; top: 10px; left: 10px; z-index: 101;
  background: var(--primary); color: #fff; border: none; padding: 8px 12px;
  border-radius: 6px; cursor: pointer; font-size: 18px;
}
@media (max-width: 768px) { .menu-toggle { display: block; } }
.workflow-steps { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
.wf-step {
  padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer;
  border: 2px solid var(--border); background: #fff; transition: all .2s;
}
.wf-step.done { background: var(--secondary); color: #fff; border-color: var(--secondary); }
.wf-step.current { background: var(--warning); color: #fff; border-color: var(--warning); }
.markup-display { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e8f5e9; color: #2e7d32; }
.deviation-pos { color: var(--danger); font-weight: 600; }
.deviation-neg { color: var(--secondary); font-weight: 600; }
.timeline { border-left: 2px solid var(--primary-light); padding-left: 15px; margin: 10px 0; }
.timeline-event { padding: 8px 0; position: relative; }
.timeline-event::before {
  content: ''; position: absolute; left: -20px; top: 12px; width: 10px; height: 10px;
  border-radius: 50%; background: var(--primary-light);
}
.timeline-event .event-date { font-size: 10px; color: var(--text-light); }
.timeline-event .event-text { font-size: 12px; }
</style>
</head>
<body>
<button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
<div class="copy-feedback" id="copyFeedback">‚úì In Zwischenablage kopiert!</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>üåç Export Afrika Pro</h2>
    <small>Workflow Manager V7</small>
  </div>
  <div class="nav-section">
    <div class="nav-section-title">√úbersicht</div>
    <div class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')">üìä Dashboard</div>
    <div class="nav-item" data-view="analytics" onclick="switchView('analytics')">üìà Auswertungen</div>
  </div>
  <div class="nav-section">
    <div class="nav-section-title">Workflow</div>
    <div class="nav-item" data-view="inquiries" onclick="switchView('inquiries')">üìã Anfragen <span class="nav-badge" id="badgeInquiries">0</span></div>
    <div class="nav-item" data-view="shipments" onclick="switchView('shipments')">üö¢ Sendungen <span class="nav-badge green" id="badgeShipments">0</span></div>
    <div class="nav-item" data-view="tracking" onclick="switchView('tracking')">üìç Tracking (ETD/ETA) <span class="nav-badge orange" id="badgeTracking">0</span></div>
    <div class="nav-item" data-view="invoices" onclick="switchView('invoices')">üí∞ Rechnungen <span class="nav-badge" id="badgeInvoices">0</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-section-title">Referenz</div>
    <div class="nav-item" data-view="countries" onclick="switchView('countries')">üó∫Ô∏è L√§nderdatenbank</div>
    <div class="nav-item" data-view="documents" onclick="switchView('documents')">üìÑ Dokumenten-Info</div>
    <div class="nav-item" data-view="templates" onclick="switchView('templates')">‚úâÔ∏è E-Mail Vorlagen</div>
  </div>
  <div class="nav-section">
    <div class="nav-section-title">System</div>
    <div class="nav-item" data-view="notifications" onclick="switchView('notifications')">üîî Benachrichtigungen <span class="nav-badge" id="badgeNotifications">0</span></div>
    <div class="nav-item" onclick="exportData()">üíæ Daten exportieren</div>
    <div class="nav-item" onclick="document.getElementById('importFile').click()">üìÇ Daten importieren</div>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</div>

<div class="main">
  <!-- DASHBOARD VIEW -->
  <div class="view" id="view-dashboard">
    <div class="topbar">
      <h1>üìä Dashboard</h1>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="openInquiryModal()">+ Neue Anfrage</button>
        <button class="btn btn-success" onclick="openShipmentModal()">+ Neue Sendung</button>
      </div>
    </div>
    <div class="stat-cards" id="dashboardStats"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="card-title">‚ö° Aktuelle Aktivit√§ten</div>
        <div id="recentActivities">Keine Aktivit√§ten</div>
      </div>
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Verz√∂gerte Sendungen</div>
        <div id="delayedShipments">Keine verz√∂gerten Sendungen</div>
      </div>
    </div>
  </div>

  <!-- INQUIRIES VIEW -->
  <div class="view hidden" id="view-inquiries">
    <div class="topbar">
      <h1>üìã Frachtanfragen</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" class="search-box" placeholder="Suchen..." oninput="filterInquiries(this.value)">
        <button class="btn btn-primary" onclick="openInquiryModal()">+ Neue Anfrage</button>
      </div>
    </div>
    <div class="tabs" id="inquiryTabs">
      <button class="tab active" onclick="filterInquiryStatus('all',this)">Alle</button>
      <button class="tab" onclick="filterInquiryStatus('open',this)">Offen</button>
      <button class="tab" onclick="filterInquiryStatus('quoted',this)">Angeboten</button>
      <button class="tab" onclick="filterInquiryStatus('accepted',this)">Akzeptiert</button>
      <button class="tab" onclick="filterInquiryStatus('rejected',this)">Abgelehnt</button>
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Nr.</th><th>Datum</th><th>Kunde</th><th>Land</th><th>Incoterm</th><th>Transport</th><th>Markup</th><th>Kosten</th><th>Verkauf</th><th>Status</th><th>Aktionen</th>
      </tr></thead><tbody id="inquiryTableBody"></tbody></table>
    </div>
  </div>

  <!-- SHIPMENTS VIEW -->
  <div class="view hidden" id="view-shipments">
    <div class="topbar">
      <h1>üö¢ Sendungen</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" class="search-box" placeholder="Suchen..." oninput="filterShipments(this.value)">
        <button class="btn btn-success" onclick="openShipmentModal()">+ Neue Sendung</button>
      </div>
    </div>
    <div class="tabs" id="shipmentTabs">
      <button class="tab active" onclick="filterShipmentStatus('all',this)">Alle</button>
      <button class="tab" onclick="filterShipmentStatus('new',this)">Neu</button>
      <button class="tab" onclick="filterShipmentStatus('in_progress',this)">In Bearbeitung</button>
      <button class="tab" onclick="filterShipmentStatus('shipped',this)">Verschifft</button>
      <button class="tab" onclick="filterShipmentStatus('delivered',this)">Geliefert</button>
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Nr.</th><th>Kunde</th><th>Land</th><th>Incoterm</th><th>Transport</th><th>ETD</th><th>ETA</th><th>Markup</th><th>Status</th><th>Workflow</th><th>Aktionen</th>
      </tr></thead><tbody id="shipmentTableBody"></tbody></table>
    </div>
  </div>

  <!-- TRACKING VIEW -->
  <div class="view hidden" id="view-tracking">
    <div class="topbar">
      <h1>üìç Tracking (ETD/ETA)</h1>
    </div>
    <div class="tabs" id="trackingTabs">
      <button class="tab active" onclick="filterTrackingStatus('all',this)">Alle</button>
      <button class="tab" onclick="filterTrackingStatus('booked',this)">Gebucht</button>
      <button class="tab" onclick="filterTrackingStatus('departed',this)">Abgefahren</button>
      <button class="tab" onclick="filterTrackingStatus('in_transit',this)">Unterwegs</button>
      <button class="tab" onclick="filterTrackingStatus('arrived',this)">Angekommen</button>
      <button class="tab" onclick="filterTrackingStatus('delayed',this)">Verz√∂gert</button>
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Sendung</th><th>Kunde</th><th>Land</th><th>Transport</th><th>Vessel/Flight</th><th>ETD</th><th>ETA</th><th>Actual ETD</th><th>Actual ETA</th><th>Abweichung</th><th>Status</th><th>Aktionen</th>
      </tr></thead><tbody id="trackingTableBody"></tbody></table>
    </div>
  </div>

  <!-- INVOICES VIEW -->
  <div class="view hidden" id="view-invoices">
    <div class="topbar">
      <h1>üí∞ Rechnungs√ºbersicht</h1>
    </div>
    <div class="tabs" id="invoiceTabs">
      <button class="tab active" onclick="filterInvoiceStatus('all',this)">Alle</button>
      <button class="tab" onclick="filterInvoiceStatus('due',this)">F√§llig</button>
      <button class="tab" onclick="filterInvoiceStatus('overdue',this)">√úberf√§llig</button>
      <button class="tab" onclick="filterInvoiceStatus('done',this)">Erledigt</button>
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Sendung</th><th>Kunde</th><th>Land</th><th>Rechnungsmonat</th><th>Trigger</th><th>RE erstellt</th><th>Status</th><th>Aktionen</th>
      </tr></thead><tbody id="invoiceTableBody"></tbody></table>
    </div>
  </div>

  <!-- COUNTRIES VIEW -->
  <div class="view hidden" id="view-countries">
    <div class="topbar">
      <h1>üó∫Ô∏è L√§nderdatenbank (54 L√§nder)</h1>
      <input type="text" class="search-box" placeholder="Land suchen..." oninput="filterCountries(this.value)">
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Land</th><th>Code</th><th>Hafen</th><th>Flughafen</th><th>See (Tage)</th><th>Luft (Tage)</th><th>Risiko</th><th>Zahlrisiko</th><th>Logistik</th><th>Sprache</th><th>Spezial-Cert</th><th>Empf. Incoterm</th>
      </tr></thead><tbody id="countryTableBody"></tbody></table>
    </div>
  </div>

  <!-- DOCUMENTS VIEW -->
  <div class="view hidden" id="view-documents">
    <div class="topbar">
      <h1>üìÑ Dokumenten-Info</h1>
      <input type="text" class="search-box" placeholder="Dokument suchen..." oninput="filterDocuments(this.value)">
    </div>
    <div class="card" style="overflow-x:auto">
      <table><thead><tr>
        <th>Dokument (EN)</th><th>Dokument (FR)</th><th>Pflicht</th><th>LC erforderlich</th><th>Bearbeitungstage</th><th>Kosten (ca.)</th><th>Aussteller</th><th>Hinweise</th>
      </tr></thead><tbody id="documentTableBody"></tbody></table>
    </div>
  </div>

  <!-- TEMPLATES VIEW -->
  <div class="view hidden" id="view-templates">
    <div class="topbar">
      <h1>‚úâÔ∏è E-Mail Vorlagen</h1>
      <input type="text" class="search-box" placeholder="Vorlage suchen..." oninput="filterTemplates(this.value)">
    </div>
    <div id="templateList"></div>
  </div>

  <!-- ANALYTICS VIEW -->
  <div class="view hidden" id="view-analytics">
    <div class="topbar"><h1>üìà Auswertungen</h1></div>
    <div class="stat-cards" id="analyticsKPIs"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="card-title">Transportmodus-Verteilung</div>
        <div class="bar-chart" id="transportChart"></div>
      </div>
      <div class="card">
        <div class="card-title">Incoterm-Verteilung</div>
        <div class="bar-chart" id="incotermChart"></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="card-title">Verz√∂gerungsgr√ºnde</div>
        <div class="bar-chart" id="delayChart"></div>
      </div>
      <div class="card">
        <div class="card-title">Rechnungsmonat-Analyse</div>
        <div id="invoiceAnalysis"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">‚ö†Ô∏è Kritische Aktivit√§ten</div>
      <div id="criticalActivities"></div>
    </div>
  </div>

  <!-- NOTIFICATIONS VIEW -->
  <div class="view hidden" id="view-notifications">
    <div class="topbar">
      <h1>üîî Benachrichtigungen</h1>
      <button class="btn btn-outline btn-sm" onclick="clearNotifications()">Alle l√∂schen</button>
    </div>
    <div class="card">
      <div class="notification-list" id="notificationList">Keine Benachrichtigungen</div>
    </div>
  </div>
</div>

<!-- INQUIRY MODAL -->
<div class="modal-overlay" id="inquiryModal">
  <div class="modal">
    <h3 id="inquiryModalTitle">Neue Frachtanfrage</h3>
    <input type="hidden" id="editInquiryId">
    <div class="form-row">
      <div class="form-group"><label>Kunde *</label><input type="text" id="inqCustomer"></div>
      <div class="form-group"><label>Land *</label>
        <select id="inqCountry"><option value="">-- W√§hlen --</option></select>
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group"><label>Incoterm *</label>
        <select id="inqIncoterm">
          <option value="">-- W√§hlen --</option>
          <option>EXW</option><option>FCA</option><option>FOB</option><option>CFR</option>
          <option>CIF</option><option>CPT</option><option>CIP</option><option>DAP</option><option>DDP</option>
        </select>
      </div>
      <div class="form-group"><label>Transport *</label>
        <select id="inqTransport">
          <option value="">-- W√§hlen --</option>
          <option value="sea">See</option><option value="air">Luft</option><option value="road">Stra√üe</option>
        </select>
      </div>
      <div class="form-group"><label>DG (Gefahrgut)</label>
        <select id="inqDG"><option value="no">Nein</option><option value="yes">Ja</option></select>
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group"><label>Frachtkosten (Einkauf) ‚Ç¨</label><input type="number" id="inqCostPrice" step="0.01" oninput="calcMarkup()"></div>
      <div class="form-group"><label>Markup %</label>
        <select id="inqMarkup" onchange="calcMarkup()">
          <option value="10">10%</option><option value="15">15%</option><option value="30" selected>30%</option>
        </select>
      </div>
      <div class="form-group"><label>Verkaufspreis ‚Ç¨</label><input type="number" id="inqSellPrice" step="0.01" readonly style="background:#f0f7ff;font-weight:600"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Gewicht (kg)</label><input type="number" id="inqWeight"></div>
      <div class="form-group"><label>Volumen (m¬≥)</label><input type="number" id="inqVolume" step="0.01"></div>
    </div>
    <div class="form-group"><label>Bemerkungen</label><textarea id="inqNotes"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px">
      <button class="btn btn-outline" onclick="closeModal('inquiryModal')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveInquiry()">Speichern</button>
    </div>
  </div>
</div>

<!-- SHIPMENT MODAL -->
<div class="modal-overlay" id="shipmentModal">
  <div class="modal">
    <h3 id="shipmentModalTitle">Neue Sendung</h3>
    <input type="hidden" id="editShipmentId">
    <div class="form-row">
      <div class="form-group"><label>Kunde *</label><input type="text" id="shipCustomer"></div>
      <div class="form-group"><label>Land *</label>
        <select id="shipCountry"><option value="">-- W√§hlen --</option></select>
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group"><label>Incoterm *</label>
        <select id="shipIncoterm">
          <option value="">-- W√§hlen --</option>
          <option>EXW</option><option>FCA</option><option>FOB</option><option>CFR</option>
          <option>CIF</option><option>CPT</option><option>CIP</option><option>DAP</option><option>DDP</option>
        </select>
      </div>
      <div class="form-group"><label>Transport *</label>
        <select id="shipTransport">
          <option value="">-- W√§hlen --</option>
          <option value="sea">See</option><option value="air">Luft</option><option value="road">Stra√üe</option>
        </select>
      </div>
      <div class="form-group"><label>DG</label>
        <select id="shipDG"><option value="no">Nein</option><option value="yes">Ja</option></select>
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group"><label>Frachtkosten ‚Ç¨</label><input type="number" id="shipCost" step="0.01"></div>
      <div class="form-group"><label>Markup %</label>
        <select id="shipMarkup"><option value="10">10%</option><option value="15">15%</option><option value="30" selected>30%</option></select>
      </div>
      <div class="form-group"><label>ETD</label><input type="date" id="shipETD"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ETA</label><input type="date" id="shipETA"></div>
      <div class="form-group"><label>Ware versendet am</label><input type="date" id="shipGoodsDispatched"></div>
    </div>
    <div class="form-group"><label>Bemerkungen</label><textarea id="shipNotes"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px">
      <button class="btn btn-outline" onclick="closeModal('shipmentModal')">Abbrechen</button>
      <button class="btn btn-success" onclick="saveShipment()">Speichern</button>
    </div>
  </div>
</div>

<!-- TRACKING MODAL -->
<div class="modal-overlay" id="trackingModal">
  <div class="modal">
    <h3>üìç Tracking aktualisieren</h3>
    <input type="hidden" id="trackShipId">
    <div class="form-row">
      <div class="form-group"><label>Tracking Status</label>
        <select id="trackStatus">
          <option value="booked">Gebucht</option><option value="departed">Abgefahren</option>
          <option value="in_transit">Unterwegs</option><option value="arrived">Angekommen</option>
          <option value="delivered">Geliefert</option><option value="delayed">Verz√∂gert</option>
        </select>
      </div>
      <div class="form-group"><label>Vessel / Flight</label><input type="text" id="trackVessel"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Tats√§chl. ETD</label><input type="date" id="trackActualETD"></div>
      <div class="form-group"><label>Tats√§chl. ETA</label><input type="date" id="trackActualETA"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Geliefert am</label><input type="date" id="trackDelivered"></div>
      <div class="form-group"><label>Verz√∂gerungsgrund</label>
        <select id="trackDelayReason">
          <option value="">-- Kein --</option>
          <option value="port_congestion">Hafenstau</option>
          <option value="weather">Wetter</option>
          <option value="customs">Zoll</option>
          <option value="documentation">Dokumente</option>
          <option value="vessel_delay">Schiffsversp√§tung</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label>Ereignis-Notiz</label><input type="text" id="trackEventNote"></div>
    <div style="margin:15px 0">
      <strong style="font-size:12px">Bisherige Ereignisse:</strong>
      <div class="timeline" id="trackTimeline"></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal('trackingModal')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveTracking()">Aktualisieren</button>
    </div>
  </div>
</div>

<!-- WORKFLOW MODAL -->
<div class="modal-overlay" id="workflowModal">
  <div class="modal">
    <h3 id="wfTitle">Workflow</h3>
    <div id="wfContent"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px">
      <button class="btn btn-outline" onclick="closeModal('workflowModal')">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA STORES
// ============================================================
const STORAGE_KEYS = {
  inquiries: 'eapInquiriesV7',
  shipments: 'eapShipmentsV7',
  notifications: 'eapNotificationsV7',
  settings: 'eapSettingsV7'
};

let inquiries = JSON.parse(localStorage.getItem(STORAGE_KEYS.inquiries) || '[]');
let shipments = JSON.parse(localStorage.getItem(STORAGE_KEYS.shipments) || '[]');
let notifications = JSON.parse(localStorage.getItem(STORAGE_KEYS.notifications) || '[]');
let currentInquiryFilter = 'all';
let currentShipmentFilter = 'all';
let currentTrackingFilter = 'all';
let currentInvoiceFilter = 'all';

function save() {
  localStorage.setItem(STORAGE_KEYS.inquiries, JSON.stringify(inquiries));
  localStorage.setItem(STORAGE_KEYS.shipments, JSON.stringify(shipments));
  localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(notifications));
}

// ============================================================
// COUNTRY DATABASE - 54 African Countries
// ============================================================
const countries = [
  {name:"Algerien",code:"DZ",port:"Algiers",airport:"ALG",transitSea:12,transitAir:5,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR/AR",specialCert:"",recommended:"CFR,CIF",notRecommended:"DDP",notes:"Importlizenzen erforderlich"},
  {name:"Angola",code:"AO",port:"Luanda",airport:"LAD",transitSea:25,transitAir:8,risk:"high",payRisk:"high",logistics:"low",language:"PT",specialCert:"CNCA",recommended:"CFR,FOB",notRecommended:"DDP,DAP",notes:"CNCA Zertifikat pflicht"},
  {name:"√Ñquatorialguinea",code:"GQ",port:"Malabo",airport:"SSG",transitSea:28,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"ES/FR",specialCert:"",recommended:"FOB,CFR",notRecommended:"DDP",notes:"Kleine Marktgr√∂√üe"},
  {name:"√Ñthiopien",code:"ET",port:"Djibouti (transit)",airport:"ADD",transitSea:30,transitAir:7,risk:"medium",payRisk:"medium",logistics:"medium",language:"AM/EN",specialCert:"CoC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"Binnenland, Transit √ºber Djibouti"},
  {name:"Benin",code:"BJ",port:"Cotonou",airport:"COO",transitSea:22,transitAir:8,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"ECTN pflicht"},
  {name:"Botswana",code:"BW",port:"Durban (transit)",airport:"GBE",transitSea:32,transitAir:9,risk:"low",payRisk:"low",logistics:"medium",language:"EN",specialCert:"",recommended:"CFR,CPT",notRecommended:"",notes:"Binnenland, Transit √ºber S√ºdafrika"},
  {name:"Burkina Faso",code:"BF",port:"Abidjan/Lom√© (transit)",airport:"OUA",transitSea:28,transitAir:9,risk:"high",payRisk:"medium",logistics:"low",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR",notRecommended:"DDP",notes:"Binnenland, ECTN pflicht"},
  {name:"Burundi",code:"BI",port:"Dar es Salaam (transit)",airport:"BJM",transitSea:35,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"",recommended:"FOB,CFR",notRecommended:"DDP",notes:"Binnenland"},
  {name:"Djibouti",code:"DJ",port:"Djibouti",airport:"JIB",transitSea:18,transitAir:7,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR/AR",specialCert:"",recommended:"CFR,CIF",notRecommended:"DDP",notes:"Strategischer Transithafen"},
  {name:"DR Kongo",code:"CD",port:"Matadi/Pointe-Noire",airport:"FIH",transitSea:28,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"FERI/ECTN",recommended:"FOB",notRecommended:"DDP,DAP",notes:"FERI erforderlich, hohe Korruption"},
  {name:"Elfenbeink√ºste",code:"CI",port:"Abidjan",airport:"ABJ",transitSea:20,transitAir:7,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR",specialCert:"ECTN/BSC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"BSC pflicht, Hub f√ºr Westafrika"},
  {name:"Eritrea",code:"ER",port:"Massawa",airport:"ASM",transitSea:20,transitAir:8,risk:"high",payRisk:"high",logistics:"low",language:"TI/AR",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP,CIF",notes:"Sanktionen pr√ºfen!"},
  {name:"Eswatini",code:"SZ",port:"Durban (transit)",airport:"MTS",transitSea:32,transitAir:9,risk:"low",payRisk:"low",logistics:"medium",language:"EN",specialCert:"",recommended:"CFR,CPT",notRecommended:"",notes:"Binnenland"},
  {name:"Gabun",code:"GA",port:"Libreville",airport:"LBV",transitSea:24,transitAir:8,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"ECTN pflicht"},
  {name:"Gambia",code:"GM",port:"Banjul",airport:"BJL",transitSea:20,transitAir:8,risk:"medium",payRisk:"medium",logistics:"low",language:"EN",specialCert:"",recommended:"CFR",notRecommended:"DDP",notes:"Kleiner Markt"},
  {name:"Ghana",code:"GH",port:"Tema",airport:"ACC",transitSea:22,transitAir:7,risk:"low",payRisk:"low",logistics:"good",language:"EN",specialCert:"SONCAP√§hnl.",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"Gute Infrastruktur"},
  {name:"Guinea",code:"GN",port:"Conakry",airport:"CKY",transitSea:22,transitAir:8,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"ECTN",recommended:"FOB,CFR",notRecommended:"DDP",notes:"ECTN pflicht"},
  {name:"Guinea-Bissau",code:"GW",port:"Bissau",airport:"OXB",transitSea:24,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"PT",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"Sehr kleine Infrastruktur"},
  {name:"Kamerun",code:"CM",port:"Douala",airport:"DLA",transitSea:22,transitAir:7,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR/EN",specialCert:"ECTN/BESC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"ECTN pflicht, Hub f√ºr Zentralafrika"},
  {name:"Kap Verde",code:"CV",port:"Praia",airport:"RAI",transitSea:18,transitAir:7,risk:"low",payRisk:"low",logistics:"medium",language:"PT",specialCert:"",recommended:"CFR,CIF",notRecommended:"",notes:"Inselstaat"},
  {name:"Kenia",code:"KE",port:"Mombasa",airport:"NBO",transitSea:25,transitAir:7,risk:"low",payRisk:"low",logistics:"good",language:"EN/SW",specialCert:"PVOC",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"PVOC pflicht, Hub f√ºr Ostafrika"},
  {name:"Komoren",code:"KM",port:"Moroni",airport:"HAH",transitSea:30,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"FR/AR",specialCert:"",recommended:"CFR",notRecommended:"DDP",notes:"Inselstaat, schwierige Logistik"},
  {name:"Kongo (Rep.)",code:"CG",port:"Pointe-Noire",airport:"BZV",transitSea:25,transitAir:8,risk:"medium",payRisk:"medium",logistics:"low",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR",notRecommended:"DDP",notes:"ECTN pflicht"},
  {name:"Lesotho",code:"LS",port:"Durban (transit)",airport:"MSU",transitSea:33,transitAir:10,risk:"medium",payRisk:"medium",logistics:"low",language:"EN",specialCert:"",recommended:"CPT",notRecommended:"DDP",notes:"Binnenland"},
  {name:"Liberia",code:"LR",port:"Monrovia",airport:"ROB",transitSea:22,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"EN",specialCert:"",recommended:"FOB,CFR",notRecommended:"DDP",notes:"Aufbauphase"},
  {name:"Libyen",code:"LY",port:"Tripoli/Misrata",airport:"TIP",transitSea:10,transitAir:5,risk:"high",payRisk:"high",logistics:"low",language:"AR",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"Instabile Lage, Sanktionen pr√ºfen!"},
  {name:"Madagaskar",code:"MG",port:"Toamasina",airport:"TNR",transitSea:28,transitAir:9,risk:"medium",payRisk:"medium",logistics:"low",language:"FR/MG",specialCert:"ECTN/BSC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"BSC erforderlich, Inselstaat"},
  {name:"Malawi",code:"MW",port:"Beira/Nacala (transit)",airport:"LLW",transitSea:35,transitAir:10,risk:"medium",payRisk:"medium",logistics:"low",language:"EN",specialCert:"",recommended:"CFR,CPT",notRecommended:"DDP",notes:"Binnenland"},
  {name:"Mali",code:"ML",port:"Dakar/Abidjan (transit)",airport:"BKO",transitSea:30,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR",notRecommended:"DDP",notes:"Binnenland, ECTN pflicht"},
  {name:"Marokko",code:"MA",port:"Casablanca/Tanger Med",airport:"CMN",transitSea:8,transitAir:4,risk:"low",payRisk:"low",logistics:"good",language:"FR/AR",specialCert:"",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"Beste Infrastruktur in Nordafrika"},
  {name:"Mauretanien",code:"MR",port:"Nouakchott",airport:"NKC",transitSea:18,transitAir:8,risk:"high",payRisk:"high",logistics:"low",language:"FR/AR",specialCert:"",recommended:"CFR",notRecommended:"DDP",notes:"Schwache Infrastruktur"},
  {name:"Mauritius",code:"MU",port:"Port Louis",airport:"MRU",transitSea:28,transitAir:10,risk:"low",payRisk:"low",logistics:"good",language:"EN/FR",specialCert:"",recommended:"CFR,CIF",notRecommended:"",notes:"Inselstaat, gute Infrastruktur"},
  {name:"Mosambik",code:"MZ",port:"Maputo/Beira",airport:"MPM",transitSea:28,transitAir:9,risk:"medium",payRisk:"medium",logistics:"medium",language:"PT",specialCert:"",recommended:"CFR,CIF",notRecommended:"DDP",notes:"Wachsender Markt"},
  {name:"Namibia",code:"NA",port:"Walvis Bay",airport:"WDH",transitSea:25,transitAir:9,risk:"low",payRisk:"low",logistics:"medium",language:"EN",specialCert:"",recommended:"CFR,CIF",notRecommended:"",notes:"Gute Hafeninfrastruktur"},
  {name:"Niger",code:"NE",port:"Cotonou/Lom√© (transit)",airport:"NIM",transitSea:30,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR",notRecommended:"DDP",notes:"Binnenland, ECTN pflicht"},
  {name:"Nigeria",code:"NG",port:"Lagos/Apapa/Tincan",airport:"LOS",transitSea:22,transitAir:7,risk:"medium",payRisk:"medium",logistics:"medium",language:"EN",specialCert:"SON/SONCAP",recommended:"CFR,CIF,FOB",notRecommended:"DDP",notes:"SON/SONCAP pflicht, gr√∂√üter Markt"},
  {name:"Ruanda",code:"RW",port:"Dar es Salaam (transit)",airport:"KGL",transitSea:35,transitAir:8,risk:"low",payRisk:"low",logistics:"medium",language:"EN/FR",specialCert:"",recommended:"CFR,CPT",notRecommended:"",notes:"Binnenland, gute Governance"},
  {name:"Sambia",code:"ZM",port:"Dar es Salaam/Durban (transit)",airport:"LUN",transitSea:35,transitAir:9,risk:"medium",payRisk:"medium",logistics:"medium",language:"EN",specialCert:"",recommended:"CFR,CPT",notRecommended:"DDP",notes:"Binnenland"},
  {name:"S√£o Tom√©",code:"ST",port:"S√£o Tom√©",airport:"TMS",transitSea:28,transitAir:10,risk:"medium",payRisk:"medium",logistics:"low",language:"PT",specialCert:"",recommended:"CFR",notRecommended:"DDP",notes:"Kleiner Inselstaat"},
  {name:"Senegal",code:"SN",port:"Dakar",airport:"DSS",transitSea:18,transitAir:7,risk:"low",payRisk:"low",logistics:"good",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR,CIF",notRecommended:"",notes:"ECTN pflicht, Hub f√ºr Westafrika"},
  {name:"Seychellen",code:"SC",port:"Victoria",airport:"SEZ",transitSea:30,transitAir:10,risk:"low",payRisk:"low",logistics:"medium",language:"EN/FR",specialCert:"",recommended:"CIF",notRecommended:"",notes:"Inselstaat"},
  {name:"Sierra Leone",code:"SL",port:"Freetown",airport:"FNA",transitSea:22,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"EN",specialCert:"",recommended:"FOB,CFR",notRecommended:"DDP",notes:"Aufbauphase"},
  {name:"Simbabwe",code:"ZW",port:"Durban/Beira (transit)",airport:"HRE",transitSea:35,transitAir:9,risk:"high",payRisk:"high",logistics:"low",language:"EN",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"Devisenprobleme"},
  {name:"Somalia",code:"SO",port:"Mogadishu",airport:"MGQ",transitSea:22,transitAir:8,risk:"high",payRisk:"high",logistics:"low",language:"SO/AR",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP,CIF",notes:"Hohes Sicherheitsrisiko"},
  {name:"S√ºdafrika",code:"ZA",port:"Durban/Cape Town",airport:"JNB",transitSea:22,transitAir:8,risk:"low",payRisk:"low",logistics:"good",language:"EN",specialCert:"",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"Beste Infrastruktur, gr√∂√üte Wirtschaft"},
  {name:"Sudan",code:"SD",port:"Port Sudan",airport:"KRT",transitSea:18,transitAir:7,risk:"high",payRisk:"high",logistics:"low",language:"AR",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"Sanktionen pr√ºfen!"},
  {name:"S√ºdsudan",code:"SS",port:"Mombasa (transit)",airport:"JUB",transitSea:40,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"EN",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"J√ºngster Staat, schlechte Infrastruktur"},
  {name:"Tansania",code:"TZ",port:"Dar es Salaam",airport:"DAR",transitSea:25,transitAir:8,risk:"medium",payRisk:"low",logistics:"medium",language:"EN/SW",specialCert:"PVOC/TBS",recommended:"CFR,CIF",notRecommended:"DDP",notes:"Hub f√ºr Ostafrika, PVOC teils pflicht"},
  {name:"Togo",code:"TG",port:"Lom√©",airport:"LFW",transitSea:22,transitAir:8,risk:"medium",payRisk:"medium",logistics:"medium",language:"FR",specialCert:"ECTN/BESC",recommended:"CFR,CIF",notRecommended:"DDP",notes:"ECTN pflicht, Transithub"},
  {name:"Tschad",code:"TD",port:"Douala (transit)",airport:"NDJ",transitSea:35,transitAir:10,risk:"high",payRisk:"high",logistics:"low",language:"FR/AR",specialCert:"ECTN/BESC",recommended:"CFR",notRecommended:"DDP",notes:"Binnenland, ECTN pflicht"},
  {name:"Tunesien",code:"TN",port:"Tunis/Rad√®s",airport:"TUN",transitSea:8,transitAir:4,risk:"low",payRisk:"low",logistics:"good",language:"FR/AR",specialCert:"",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"Gute Infrastruktur"},
  {name:"Uganda",code:"UG",port:"Mombasa (transit)",airport:"EBB",transitSea:32,transitAir:8,risk:"medium",payRisk:"medium",logistics:"medium",language:"EN",specialCert:"PVOC",recommended:"CFR,CPT",notRecommended:"DDP",notes:"Binnenland, PVOC pflicht"},
  {name:"Zentralafrik. Rep.",code:"CF",port:"Douala (transit)",airport:"BGF",transitSea:38,transitAir:11,risk:"high",payRisk:"high",logistics:"low",language:"FR",specialCert:"",recommended:"FOB",notRecommended:"DDP,DAP",notes:"Instabil, schlechte Infrastruktur"},
  {name:"√Ñgypten",code:"EG",port:"Alexandria/Port Said",airport:"CAI",transitSea:10,transitAir:5,risk:"low",payRisk:"low",logistics:"good",language:"AR",specialCert:"",recommended:"CFR,CIF,FOB",notRecommended:"",notes:"Suezkanal, gute Infrastruktur"}
];

// ============================================================
// DOCUMENT DATABASE
// ============================================================
const documents = [
  {en:"Commercial Invoice",fr:"Facture Commerciale",mandatory:true,lc:true,days:1,cost:"0‚Ç¨",issuer:"Exporteur",notes:"Muss mit LC exakt √ºbereinstimmen"},
  {en:"Packing List",fr:"Liste de Colisage",mandatory:true,lc:true,days:1,cost:"0‚Ç¨",issuer:"Exporteur",notes:"Gewichte, Ma√üe, Markierungen"},
  {en:"Certificate of Origin",fr:"Certificat d'Origine",mandatory:true,lc:true,days:2,cost:"20-50‚Ç¨",issuer:"IHK",notes:"Oft legalisiert erforderlich"},
  {en:"Bill of Lading",fr:"Connaissement",mandatory:true,lc:true,days:3,cost:"50-150‚Ç¨",issuer:"Reederei",notes:"CargoX eBL m√∂glich"},
  {en:"Air Waybill",fr:"Lettre de Transport A√©rien",mandatory:true,lc:true,days:1,cost:"inkl.",issuer:"Airline/Spediteur",notes:"Nicht negotiable"},
  {en:"Insurance Certificate",fr:"Certificat d'Assurance",mandatory:false,lc:true,days:2,cost:"0.3-1.5%",issuer:"Versicherung",notes:"CIF/CIP pflicht, 110% Warenwert"},
  {en:"ECTN/BESC",fr:"ECTN/BESC",mandatory:true,lc:false,days:5,cost:"150-350‚Ç¨",issuer:"Beh√∂rde/Agent",notes:"Westafrika pflicht, vor Verschiffung"},
  {en:"SON/SONCAP",fr:"SON/SONCAP",mandatory:true,lc:false,days:10,cost:"300-800‚Ç¨",issuer:"SON Nigeria",notes:"Nigeria pflicht, Produktzertifizierung"},
  {en:"PVOC",fr:"PVOC",mandatory:true,lc:false,days:7,cost:"200-500‚Ç¨",issuer:"Pr√ºfgesellschaft",notes:"Ostafrika (KE, UG, TZ)"},
  {en:"Health Certificate",fr:"Certificat Sanitaire",mandatory:false,lc:false,days:3,cost:"50-100‚Ç¨",issuer:"Gesundheitsamt",notes:"F√ºr Lebensmittel/Pharma"},
  {en:"DG Declaration",fr:"D√©claration de Marchandises Dangereuses",mandatory:true,lc:false,days:2,cost:"0‚Ç¨",issuer:"Versender (IATA zert.)",notes:"IATA DGR / IMDG Code"},
  {en:"MSDS/SDS",fr:"Fiche de Donn√©es de S√©curit√©",mandatory:true,lc:false,days:1,cost:"0‚Ç¨",issuer:"Hersteller",notes:"16 Abschnitte, Landessprache"},
  {en:"EUR.1",fr:"EUR.1",mandatory:false,lc:false,days:2,cost:"20‚Ç¨",issuer:"Zollamt",notes:"Pr√§ferenznachweis (Marokko, Tunesien)"},
  {en:"Export License",fr:"Licence d'Exportation",mandatory:false,lc:false,days:14,cost:"variabel",issuer:"BAFA/Beh√∂rde",notes:"Dual-Use, R√ºstungsg√ºter, Embargos"}
];

// ============================================================
// EMAIL TEMPLATES
// ============================================================
const emailTemplates = [
  {id:"freight-inquiry-sea",title:"Frachtanfrage See",cat:"Anfrage",text:`Betreff: Frachtanfrage Seefracht nach [LAND]\n\nSehr geehrte Damen und Herren,\n\nwir bitten um ein Frachtangebot f√ºr folgende Sendung:\n\nAbgangshafen: Hamburg/Bremerhaven\nZielhafen: [HAFEN]\nWare: [WARENBESCHREIBUNG]\nGewicht: [GEWICHT] kg\nVolumen: [VOLUMEN] m¬≥\nContainer: [20'/40'/40'HC/LCL]\nIncoterm: [INCOTERM]\nGefahrgut: [JA/NEIN]\n\nBitte inkl. THC, BAF, CAF und etwaiger Zuschl√§ge.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"freight-inquiry-air",title:"Frachtanfrage Luft",cat:"Anfrage",text:`Betreff: Frachtanfrage Luftfracht nach [LAND]\n\nSehr geehrte Damen und Herren,\n\nwir bitten um ein Frachtangebot:\n\nAbflughafen: [FRA/MUC/CGN]\nZielflughafen: [FLUGHAFEN]\nWare: [WARENBESCHREIBUNG]\nBrutto: [GEWICHT] kg / Vol.-Gew.: [VOLGEWICHT] kg\nMa√üe: [LxBxH cm]\nGefahrgut: [JA/NEIN ‚Äì UN-Nr.]\n\nBitte inkl. FSC, SCC und Handling.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"freight-inquiry-road",title:"Frachtanfrage Stra√üe",cat:"Anfrage",text:`Betreff: Frachtanfrage LKW-Transport nach [LAND]\n\nSehr geehrte Damen und Herren,\n\nwir ben√∂tigen ein Angebot f√ºr LKW-Transport:\n\nAbholung: [PLZ ORT]\nLieferung: [ZIELORT, LAND]\nWare: [WARENBESCHREIBUNG]\nGewicht: [GEWICHT] kg / [PALETTEN] Paletten\nLademeter: [LDM]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"freight-inquiry-dg",title:"Frachtanfrage Gefahrgut",cat:"Anfrage",text:`Betreff: Frachtanfrage Gefahrgut nach [LAND]\n\nSehr geehrte Damen und Herren,\n\nwir bitten um ein DG-Frachtangebot:\n\nUN-Nummer: [UN-NR]\nKlasse: [KLASSE]\nVerpackungsgruppe: [PG I/II/III]\nProper Shipping Name: [PSN]\nNettomenge: [MENGE kg/l]\nVerpackung: [VERPACKUNGSART]\nTransportmodus: [SEE/LUFT]\nZiel: [HAFEN/FLUGHAFEN, LAND]\n\nMSDS/SDS anbei.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"fca-docs",title:"FCA Dokumente anfordern",cat:"Dokumente",text:`Betreff: Dokumente f√ºr FCA-Sendung [REF]\n\nSehr geehrte/r [KUNDE],\n\nbitte stellen Sie folgende Dokumente f√ºr die Abholung bereit:\n\n- Handelsrechnung (3-fach)\n- Packliste (3-fach)\n- Ursprungszeugnis\n- [WEITERE DOKUMENTE]\n\nAbholtermin: [DATUM]\nSpediteur: [SPEDITEUR]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"other-docs",title:"Zusatzdokumente anfordern",cat:"Dokumente",text:`Betreff: Zus√§tzliche Dokumente ben√∂tigt - [REF]\n\nSehr geehrte/r [KUNDE],\n\nf√ºr die Sendung nach [LAND] werden zus√§tzlich ben√∂tigt:\n\n- [DOKUMENT 1]\n- [DOKUMENT 2]\n\nBitte bis [DATUM] zusenden.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"draft-bl",title:"Draft B/L Pr√ºfung",cat:"Versand",text:`Betreff: Draft B/L zur Pr√ºfung - [REF]\n\nSehr geehrte Damen und Herren,\n\nbitte senden Sie den Draft B/L zur Pr√ºfung.\n\nBitte beachten:\n- Shipper: [SHIPPER]\n- Consignee: [CONSIGNEE]\n- Notify: [NOTIFY]\n- Beschreibung: [WARENBESCHREIBUNG]\n- Markierung: [MARKS & NUMBERS]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"bl-confirm",title:"B/L Best√§tigung",cat:"Versand",text:`Betreff: B/L Freigabe - [REF]\n\nSehr geehrte Damen und Herren,\n\nder Draft B/L ist gepr√ºft und freigegeben.\nBitte Original ausstellen / CargoX eBL √ºbertragen.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"final-docs",title:"Versanddokumente senden",cat:"Versand",text:`Betreff: Versanddokumente - [REF] nach [LAND]\n\nSehr geehrte/r [KUNDE],\n\nanbei die Versanddokumente:\n\n1. Commercial Invoice\n2. Packing List\n3. Bill of Lading / AWB\n4. Certificate of Origin\n5. [WEITERE]\n\nVessel/Flight: [VESSEL]\nETD: [ETD]\nETA: [ETA]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"bank-dsv",title:"Bankvorlage / DSV",cat:"Bank",text:`Betreff: Dokumentenvorlage - [REF]\n\nSehr geehrte Damen und Herren,\n\nanbei die Dokumente zur Vorlage/Inkasso:\n\nLC-Nr.: [LC-NR]\nBetrag: [BETRAG] [W√ÑHRUNG]\n\nDokumente:\n- Commercial Invoice (Original)\n- B/L (Original)\n- Packing List\n- Certificate of Origin\n- [WEITERE]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"pickup-reminder",title:"Abholung Erinnerung (FCA/EXW)",cat:"Logistik",text:`Betreff: Erinnerung Abholtermin - [REF]\n\nSehr geehrte/r [SPEDITEUR/KUNDE],\n\nErinnerung an den Abholtermin:\n\nDatum: [DATUM]\nUhrzeit: [UHRZEIT]\nAdresse: [ADRESSE]\nReferenz: [REF]\nWare: [WARENBESCHREIBUNG]\nGewicht: [GEWICHT] kg\n\nBitte Best√§tigung.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"eta-update",title:"ETA Update",cat:"Tracking",text:`Betreff: ETA Update - [REF] nach [LAND]\n\nSehr geehrte/r [KUNDE],\n\nUpdate zu Ihrer Sendung:\n\nVessel/Flight: [VESSEL]\nUrspr√ºngliche ETA: [ETA_ALT]\nAktuelle ETA: [ETA_NEU]\nGrund: [GRUND]\n\nWir halten Sie informiert.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"invoice-notice",title:"Rechnungsank√ºndigung",cat:"Rechnung",text:`Betreff: Rechnung Sendung [REF]\n\nSehr geehrte/r [KUNDE],\n\ndie Rechnung f√ºr Sendung [REF] nach [LAND] wird im [MONAT] erstellt.\n\nFreightkosten: [BETRAG] ‚Ç¨\nIncoterm: [INCOTERM]\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"ectn-apply",title:"ECTN/BESC Beantragung",cat:"Zertifikate",text:`Betreff: ECTN/BESC Antrag - [REF] nach [LAND]\n\nSehr geehrte Damen und Herren,\n\nbitte ECTN/BESC beantragen:\n\nShipper: [SHIPPER]\nConsignee: [CONSIGNEE]\nB/L Nr.: [BL-NR]\nWare: [WARENBESCHREIBUNG]\nHS-Code: [HS-CODE]\nWert: [WERT] [W√ÑHRUNG]\nHafen: [ZIELHAFEN]\n\nDokumente anbei.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"cargox-confirm",title:"CargoX eBL Best√§tigung",cat:"Digital",text:`Betreff: CargoX eBL Transfer - [REF]\n\nSehr geehrte/r [KUNDE],\n\nder eBL wurde √ºber CargoX √ºbertragen:\n\nCargoX ID: [CARGOX-ID]\nB/L Nr.: [BL-NR]\nVessel: [VESSEL]\n\nBitte im CargoX Portal best√§tigen.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`},
  {id:"delay-notice",title:"Verz√∂gerungsmeldung",cat:"Tracking",text:`Betreff: Verz√∂gerung Sendung [REF]\n\nSehr geehrte/r [KUNDE],\n\nleider m√ºssen wir eine Verz√∂gerung melden:\n\nSendung: [REF]\nGrund: [GRUND]\nUrspr√ºngliche ETA: [ETA_ALT]\nNeue gesch√§tzte ETA: [ETA_NEU]\nVerz√∂gerung: ca. [TAGE] Tage\n\nWir entschuldigen uns und halten Sie auf dem Laufenden.\n\nMit freundlichen Gr√º√üen\nExport Afrika Pro GmbH`}
];

// ============================================================
// WORKFLOW DEFINITIONS
// ============================================================
function getWorkflowSteps(incoterm, isDG) {
  const common = ['Anfrage erhalten','Dokumente pr√ºfen','Rechnung erstellen'];
  const dgSteps = isDG ? ['DG Deklaration','MSDS pr√ºfen','DG Label erstellen'] : [];
  const steps = {
    'EXW': ['Abholung koordinieren','Ware abholen',...dgSteps,'Exportzoll','Verladung','Versanddokumente','Tracking','Zustellung best√§tigen',...common],
    'FCA': ['Ware bereitstellen','Abholung/√úbergabe',...dgSteps,'Exportzoll','Versanddokumente','Tracking','Zustellung best√§tigen',...common],
    'FOB': [...dgSteps,'Exportzoll','Verladung Hafen','B/L erhalten','Versanddokumente',...common],
    'CFR': [...dgSteps,'Fracht buchen','Exportzoll','Verladung','B/L erhalten','Versanddokumente','Tracking','Ankunft best√§tigen',...common],
    'CIF': [...dgSteps,'Fracht buchen','Versicherung','Exportzoll','Verladung','B/L erhalten','Versanddokumente','Tracking','Ankunft best√§tigen',...common],
    'CPT': [...dgSteps,'Fracht buchen','Exportzoll','Verladung','AWB/B/L erhalten','Versanddokumente','Tracking',...common],
    'CIP': [...dgSteps,'Fracht buchen','Versicherung','Exportzoll','Verladung','AWB/B/L erhalten','Versanddokumente','Tracking',...common],
    'DAP': [...dgSteps,'Fracht buchen','Exportzoll','Verladung','B/L erhalten','Versanddokumente','Tracking','Import Zoll','Zustellung',...common],
    'DDP': [...dgSteps,'Fracht buchen','Exportzoll','Verladung','B/L erhalten','Versanddokumente','Tracking','Import Zoll','Einfuhrabgaben','Zustellung',...common]
  };
  return steps[incoterm] || [...dgSteps,'Fracht buchen','Exportzoll','Verladung','Versanddokumente','Tracking',...common];
}

// ============================================================
// HELPER FUNCTIONS
// ============================================================
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('de-DE') : '-'; }
function formatCurrency(v) { return v ? parseFloat(v).toFixed(2) + ' ‚Ç¨' : '-'; }
function daysBetween(d1, d2) { return Math.round((new Date(d2) - new Date(d1)) / 86400000); }

function getMonthName(m) {
  const names = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  return names[m] || '?';
}

function getInvoiceDeadlineMonth(ship) {
  if (ship.tracking?.deliveredDate) return new Date(ship.tracking.deliveredDate);
  if (ship.tracking?.actualETA) return new Date(ship.tracking.actualETA);
  if (ship.etaDate) return new Date(ship.etaDate);
  if (ship.goodsDispatchedDate) return new Date(ship.goodsDispatchedDate);
  return null;
}

function isInvoiceMonthOverdue(ship) {
  const deadline = getInvoiceDeadlineMonth(ship);
  if (!deadline || ship.invoiceCreatedDate) return false;
  const now = new Date();
  const deadlineMonth = new Date(deadline.getFullYear(), deadline.getMonth() + 1, 0);
  return now > deadlineMonth;
}

function getCountryByName(name) { return countries.find(c => c.name === name); }

function getRiskClass(risk) {
  if (risk === 'low') return 'risk-low';
  if (risk === 'high') return 'risk-high';
  return 'risk-medium';
}

function getStatusBadge(status) {
  const map = {
    open:'status-new',new:'status-new',quoted:'status-inprogress',
    accepted:'status-completed',in_progress:'status-inprogress',
    shipped:'status-shipped',delivered:'status-delivered',
    rejected:'status-delayed',delayed:'status-delayed',
    booked:'status-new',departed:'status-inprogress',in_transit:'status-shipped',
    arrived:'status-completed'
  };
  const labels = {
    open:'Offen',new:'Neu',quoted:'Angeboten',accepted:'Akzeptiert',
    in_progress:'In Bearbeitung',shipped:'Verschifft',delivered:'Geliefert',
    rejected:'Abgelehnt',delayed:'Verz√∂gert',booked:'Gebucht',
    departed:'Abgefahren',in_transit:'Unterwegs',arrived:'Angekommen'
  };
  return `<span class="status-badge ${map[status]||''}">${labels[status]||status}</span>`;
}

function addNotification(text, type='info') {
  notifications.unshift({ id: generateId(), text, type, date: new Date().toISOString(), read: false });
  if (notifications.length > 50) notifications.pop();
  save();
}

// ============================================================
// UI FUNCTIONS
// ============================================================
function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById('view-' + view).classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');
  if (view === 'dashboard') renderDashboard();
  if (view === 'inquiries') renderInquiries();
  if (view === 'shipments') renderShipments();
  if (view === 'tracking') renderTracking();
  if (view === 'invoices') renderInvoices();
  if (view === 'countries') renderCountries();
  if (view === 'documents') renderDocuments();
  if (view === 'templates') renderTemplates();
  if (view === 'analytics') renderAnalytics();
  if (view === 'notifications') renderNotifications();
  // close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function showCopyFeedback() {
  const el = document.getElementById('copyFeedback');
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 2000);
}

function calcMarkup() {
  const cost = parseFloat(document.getElementById('inqCostPrice').value) || 0;
  const pct = parseInt(document.getElementById('inqMarkup').value) || 30;
  document.getElementById('inqSellPrice').value = (cost * (1 + pct / 100)).toFixed(2);
}

// ============================================================
// INQUIRY CRUD
// ============================================================
function openInquiryModal(id) {
  const sel = document.getElementById('inqCountry');
  if (sel.options.length <= 1) {
    countries.forEach(c => { const o = document.createElement('option'); o.value = c.name; o.textContent = c.name; sel.appendChild(o); });
  }
  if (id) {
    const inq = inquiries.find(i => i.id === id);
    if (!inq) return;
    document.getElementById('inquiryModalTitle').textContent = 'Anfrage bearbeiten';
    document.getElementById('editInquiryId').value = id;
    document.getElementById('inqCustomer').value = inq.customer;
    document.getElementById('inqCountry').value = inq.country;
    document.getElementById('inqIncoterm').value = inq.incoterm;
    document.getElementById('inqTransport').value = inq.transport;
    document.getElementById('inqDG').value = inq.dg ? 'yes' : 'no';
    document.getElementById('inqCostPrice').value = inq.costPrice || '';
    document.getElementById('inqMarkup').value = inq.markupPercent || 30;
    document.getElementById('inqSellPrice').value = inq.sellPrice || '';
    document.getElementById('inqWeight').value = inq.weight || '';
    document.getElementById('inqVolume').value = inq.volume || '';
    document.getElementById('inqNotes').value = inq.notes || '';
  } else {
    document.getElementById('inquiryModalTitle').textContent = 'Neue Frachtanfrage';
    document.getElementById('editInquiryId').value = '';
    ['inqCustomer','inqCostPrice','inqSellPrice','inqWeight','inqVolume','inqNotes'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('inqCountry').value = '';
    document.getElementById('inqIncoterm').value = '';
    document.getElementById('inqTransport').value = '';
    document.getElementById('inqDG').value = 'no';
    document.getElementById('inqMarkup').value = '30';
  }
  openModal('inquiryModal');
}

function saveInquiry() {
  const customer = document.getElementById('inqCustomer').value.trim();
  const country = document.getElementById('inqCountry').value;
  const incoterm = document.getElementById('inqIncoterm').value;
  const transport = document.getElementById('inqTransport').value;
  if (!customer || !country || !incoterm || !transport) return alert('Bitte alle Pflichtfelder ausf√ºllen!');

  const costPrice = parseFloat(document.getElementById('inqCostPrice').value) || 0;
  const markupPercent = parseInt(document.getElementById('inqMarkup').value) || 30;
  const sellPrice = costPrice * (1 + markupPercent / 100);
  const editId = document.getElementById('editInquiryId').value;

  const data = {
    customer, country, incoterm, transport,
    dg: document.getElementById('inqDG').value === 'yes',
    costPrice, markupPercent, sellPrice: Math.round(sellPrice * 100) / 100,
    weight: document.getElementById('inqWeight').value,
    volume: document.getElementById('inqVolume').value,
    notes: document.getElementById('inqNotes').value
  };

  if (editId) {
    const idx = inquiries.findIndex(i => i.id === editId);
    if (idx >= 0) Object.assign(inquiries[idx], data, { updatedAt: new Date().toISOString() });
  } else {
    inquiries.push({ id: generateId(), ...data, status: 'open', createdAt: new Date().toISOString(), number: 'INQ-' + (inquiries.length + 1).toString().padStart(4, '0') });
    addNotification(`Neue Anfrage: ${customer} ‚Üí ${country}`);
  }
  save();
  closeModal('inquiryModal');
  renderInquiries();
  updateBadges();
}

function updateInquiryStatus(id, status) {
  const inq = inquiries.find(i => i.id === id);
  if (inq) { inq.status = status; inq.updatedAt = new Date().toISOString(); save(); renderInquiries(); updateBadges(); }
}

function deleteInquiry(id) {
  if (!confirm('Anfrage l√∂schen?')) return;
  inquiries = inquiries.filter(i => i.id !== id);
  save(); renderInquiries(); updateBadges();
}

function convertToShipment(id) {
  const inq = inquiries.find(i => i.id === id);
  if (!inq) return;
  const c = getCountryByName(inq.country);
  const transitDays = inq.transport === 'air' ? (c?.transitAir || 10) : (c?.transitSea || 25);
  const etd = new Date(); etd.setDate(etd.getDate() + 7);
  const eta = new Date(etd); eta.setDate(eta.getDate() + transitDays);

  const ship = {
    id: generateId(), customer: inq.customer, country: inq.country,
    incoterm: inq.incoterm, transport: inq.transport, dg: inq.dg,
    costPrice: inq.costPrice, freightMarkup: inq.markupPercent,
    weight: inq.weight, volume: inq.volume, notes: inq.notes,
    status: 'new', etdDate: etd.toISOString().split('T')[0],
    etaDate: eta.toISOString().split('T')[0],
    goodsDispatchedDate: null, invoiceCreatedDate: null,
    workflowSteps: getWorkflowSteps(inq.incoterm, inq.dg).map(s => ({ name: s, done: false })),
    tracking: { status: 'booked', vessel: '', actualETD: null, actualETA: null, deliveredDate: null, delayReason: '', events: [] },
    createdAt: new Date().toISOString(),
    number: 'SHP-' + (shipments.length + 1).toString().padStart(4, '0')
  };
  shipments.push(ship);
  inq.status = 'accepted';
  save();
  addNotification(`Sendung erstellt: ${ship.number} ${ship.customer} ‚Üí ${ship.country}`);
  renderInquiries(); updateBadges();
  switchView('shipments');
}

// ============================================================
// SHIPMENT CRUD
// ============================================================
function openShipmentModal(id) {
  const sel = document.getElementById('shipCountry');
  if (sel.options.length <= 1) {
    countries.forEach(c => { const o = document.createElement('option'); o.value = c.name; o.textContent = c.name; sel.appendChild(o); });
  }
  if (id) {
    const s = shipments.find(s => s.id === id);
    if (!s) return;
    document.getElementById('shipmentModalTitle').textContent = 'Sendung bearbeiten';
    document.getElementById('editShipmentId').value = id;
    document.getElementById('shipCustomer').value = s.customer;
    document.getElementById('shipCountry').value = s.country;
    document.getElementById('shipIncoterm').value = s.incoterm;
    document.getElementById('shipTransport').value = s.transport;
    document.getElementById('shipDG').value = s.dg ? 'yes' : 'no';
    document.getElementById('shipCost').value = s.costPrice || '';
    document.getElementById('shipMarkup').value = s.freightMarkup || 30;
    document.getElementById('shipETD').value = s.etdDate || '';
    document.getElementById('shipETA').value = s.etaDate || '';
    document.getElementById('shipGoodsDispatched').value = s.goodsDispatchedDate || '';
    document.getElementById('shipNotes').value = s.notes || '';
  } else {
    document.getElementById('shipmentModalTitle').textContent = 'Neue Sendung';
    document.getElementById('editShipmentId').value = '';
    ['shipCustomer','shipCost','shipETD','shipETA','shipGoodsDispatched','shipNotes'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('shipCountry').value = '';
    document.getElementById('shipIncoterm').value = '';
    document.getElementById('shipTransport').value = '';
    document.getElementById('shipDG').value = 'no';
    document.getElementById('shipMarkup').value = '30';
  }
  openModal('shipmentModal');
}

function saveShipment() {
  const customer = document.getElementById('shipCustomer').value.trim();
  const country = document.getElementById('shipCountry').value;
  const incoterm = document.getElementById('shipIncoterm').value;
  const transport = document.getElementById('shipTransport').value;
  if (!customer || !country || !incoterm || !transport) return alert('Pflichtfelder ausf√ºllen!');

  const editId = document.getElementById('editShipmentId').value;
  const data = {
    customer, country, incoterm, transport,
    dg: document.getElementById('shipDG').value === 'yes',
    costPrice: parseFloat(document.getElementById('shipCost').value) || 0,
    freightMarkup: parseInt(document.getElementById('shipMarkup').value) || 30,
    etdDate: document.getElementById('shipETD').value || null,
    etaDate: document.getElementById('shipETA').value || null,
    goodsDispatchedDate: document.getElementById('shipGoodsDispatched').value || null,
    notes: document.getElementById('shipNotes').value
  };

  if (editId) {
    const idx = shipments.findIndex(s => s.id === editId);
    if (idx >= 0) Object.assign(shipments[idx], data, { updatedAt: new Date().toISOString() });
  } else {
    const ws = getWorkflowSteps(incoterm, data.dg);
    shipments.push({
      id: generateId(), ...data, status: 'new',
      workflowSteps: ws.map(s => ({ name: s, done: false })),
      tracking: { status: 'booked', vessel: '', actualETD: null, actualETA: null, deliveredDate: null, delayReason: '', events: [] },
      invoiceCreatedDate: null,
      createdAt: new Date().toISOString(),
      number: 'SHP-' + (shipments.length + 1).toString().padStart(4, '0')
    });
    addNotification(`Neue Sendung: ${customer} ‚Üí ${country}`);
  }
  save(); closeModal('shipmentModal'); renderShipments(); updateBadges();
}

function updateShipmentStatus(id, status) {
  const s = shipments.find(s => s.id === id);
  if (s) { s.status = status; s.updatedAt = new Date().toISOString(); if (status === 'delivered' && s.tracking) s.tracking.status = 'delivered'; save(); renderShipments(); updateBadges(); }
}

function deleteShipment(id) {
  if (!confirm('Sendung l√∂schen?')) return;
  shipments = shipments.filter(s => s.id !== id);
  save(); renderShipments(); updateBadges();
}

function markInvoiceCreated(id) {
  const s = shipments.find(s => s.id === id);
  if (s) { s.invoiceCreatedDate = new Date().toISOString().split('T')[0]; save(); renderInvoices(); updateBadges(); }
}

// ============================================================
// WORKFLOW
// ============================================================
function openWorkflow(id) {
  const s = shipments.find(s => s.id === id);
  if (!s) return;
  document.getElementById('wfTitle').textContent = `Workflow: ${s.number} - ${s.customer} ‚Üí ${s.country}`;
  let html = `<p style="margin-bottom:10px;font-size:12px;color:var(--text-light)">Incoterm: <strong>${s.incoterm}</strong> | Transport: <strong>${s.transport==='sea'?'See':s.transport==='air'?'Luft':'Stra√üe'}</strong> ${s.dg?'| ‚ö†Ô∏è Gefahrgut':''}</p>`;
  html += '<div class="workflow-steps">';
  s.workflowSteps.forEach((step, i) => {
    const cls = step.done ? 'done' : (i > 0 && s.workflowSteps[i-1].done && !step.done ? 'current' : '');
    html += `<div class="wf-step ${cls}" onclick="toggleWfStep('${s.id}',${i})">${step.done ? '‚úì ' : ''}${step.name}</div>`;
  });
  html += '</div>';
  const done = s.workflowSteps.filter(s => s.done).length;
  const pct = Math.round(done / s.workflowSteps.length * 100);
  html += `<div style="margin-top:15px;background:#eee;border-radius:10px;height:8px"><div style="width:${pct}%;background:var(--secondary);border-radius:10px;height:100%;transition:width .3s"></div></div>`;
  html += `<p style="font-size:11px;margin-top:5px;color:var(--text-light)">${done}/${s.workflowSteps.length} Schritte (${pct}%)</p>`;
  document.getElementById('wfContent').innerHTML = html;
  openModal('workflowModal');
}

function toggleWfStep(shipId, idx) {
  const s = shipments.find(s => s.id === shipId);
  if (!s) return;
  s.workflowSteps[idx].done = !s.workflowSteps[idx].done;
  // auto-update status
  const allDone = s.workflowSteps.every(st => st.done);
  const anyDone = s.workflowSteps.some(st => st.done);
  if (allDone) s.status = 'delivered';
  else if (anyDone) s.status = 'in_progress';
  else s.status = 'new';
  save();
  openWorkflow(shipId);
  renderShipments(); updateBadges();
}

// ============================================================
// TRACKING
// ============================================================
function openTrackingModal(id) {
  const s = shipments.find(s => s.id === id);
  if (!s) return;
  document.getElementById('trackShipId').value = id;
  const t = s.tracking || {};
  document.getElementById('trackStatus').value = t.status || 'booked';
  document.getElementById('trackVessel').value = t.vessel || '';
  document.getElementById('trackActualETD').value = t.actualETD || '';
  document.getElementById('trackActualETA').value = t.actualETA || '';
  document.getElementById('trackDelivered').value = t.deliveredDate || '';
  document.getElementById('trackDelayReason').value = t.delayReason || '';
  document.getElementById('trackEventNote').value = '';

  let timeline = '';
  (t.events || []).forEach(e => {
    timeline += `<div class="timeline-event"><div class="event-date">${formatDate(e.date)}</div><div class="event-text">${e.text}</div></div>`;
  });
  document.getElementById('trackTimeline').innerHTML = timeline || '<p style="font-size:11px;color:var(--text-light)">Keine Ereignisse</p>';
  openModal('trackingModal');
}

function saveTracking() {
  const id = document.getElementById('trackShipId').value;
  const s = shipments.find(s => s.id === id);
  if (!s) return;
  if (!s.tracking) s.tracking = { events: [] };
  s.tracking.status = document.getElementById('trackStatus').value;
  s.tracking.vessel = document.getElementById('trackVessel').value;
  s.tracking.actualETD = document.getElementById('trackActualETD').value || null;
  s.tracking.actualETA = document.getElementById('trackActualETA').value || null;
  s.tracking.deliveredDate = document.getElementById('trackDelivered').value || null;
  s.tracking.delayReason = document.getElementById('trackDelayReason').value;

  const note = document.getElementById('trackEventNote').value.trim();
  if (note) {
    if (!s.tracking.events) s.tracking.events = [];
    s.tracking.events.push({ date: new Date().toISOString(), text: note });
  }

  // sync statuses
  if (s.tracking.status === 'delivered') { s.status = 'delivered'; if (!s.tracking.deliveredDate) s.tracking.deliveredDate = new Date().toISOString().split('T')[0]; }
  else if (s.tracking.status === 'departed' || s.tracking.status === 'in_transit') s.status = 'shipped';
  else if (s.tracking.status === 'delayed') { s.status = 'shipped'; addNotification(`‚ö†Ô∏è Verz√∂gerung: ${s.number} ${s.customer} ‚Üí ${s.country}`, 'warning'); }

  save(); closeModal('trackingModal'); renderTracking(); renderShipments(); updateBadges();
}

// ============================================================
// RENDER FUNCTIONS
// ============================================================
function updateBadges() {
  document.getElementById('badgeInquiries').textContent = inquiries.filter(i => i.status === 'open').length;
  document.getElementById('badgeShipments').textContent = shipments.filter(s => s.status !== 'delivered').length;
  document.getElementById('badgeTracking').textContent = shipments.filter(s => !['EXW','FCA'].includes(s.incoterm) && s.tracking?.status !== 'delivered').length;
  document.getElementById('badgeInvoices').textContent = shipments.filter(s => isInvoiceMonthOverdue(s)).length;
  document.getElementById('badgeNotifications').textContent = notifications.filter(n => !n.read).length;
}

function renderDashboard() {
  const active = shipments.filter(s => s.status !== 'delivered');
  const delayed = shipments.filter(s => s.tracking?.status === 'delayed');
  const inTransit = shipments.filter(s => ['shipped','in_progress'].includes(s.status) && s.tracking?.status !== 'delivered');
  const invoiceOverdue = shipments.filter(s => isInvoiceMonthOverdue(s));

  document.getElementById('dashboardStats').innerHTML = `
    <div class="stat-card"><div class="stat-value">${inquiries.filter(i=>i.status==='open').length}</div><div class="stat-label">Offene Anfragen</div></div>
    <div class="stat-card green"><div class="stat-value">${active.length}</div><div class="stat-label">Aktive Sendungen</div></div>
    <div class="stat-card orange"><div class="stat-value">${inTransit.length}</div><div class="stat-label">Unterwegs</div></div>
    <div class="stat-card red"><div class="stat-value">${delayed.length}</div><div class="stat-label">Verz√∂gert</div></div>
    <div class="stat-card"><div class="stat-value">${shipments.filter(s=>s.status==='delivered').length}</div><div class="stat-label">Geliefert (gesamt)</div></div>
    <div class="stat-card ${invoiceOverdue.length ? 'red' : ''}""><div class="stat-value">${invoiceOverdue.length}</div><div class="stat-label">RE √ºberf√§llig</div></div>
  `;

  // Recent activities
  const recent = [...shipments].sort((a,b) => new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt)).slice(0,5);
  let actHtml = '';
  recent.forEach(s => {
    actHtml += `<div style="padding:8px 0;border-bottom:1px solid #eee;font-size:12px">
      <strong>${s.number}</strong> ${s.customer} ‚Üí ${s.country} ${getStatusBadge(s.status)}
      <div style="font-size:10px;color:var(--text-light)">${formatDate(s.updatedAt||s.createdAt)}</div>
    </div>`;
  });
  document.getElementById('recentActivities').innerHTML = actHtml || 'Keine Aktivit√§ten';

  // Delayed
  let delHtml = '';
  delayed.forEach(s => {
    const dev = s.tracking?.actualETA && s.etaDate ? daysBetween(s.etaDate, s.tracking.actualETA) : '?';
    delHtml += `<div style="padding:8px 0;border-bottom:1px solid #eee;font-size:12px">
      <strong>${s.number}</strong> ${s.customer} ‚Üí ${s.country}
      <span class="deviation-pos">+${dev} Tage</span>
      <div style="font-size:10px;color:var(--text-light)">Grund: ${s.tracking?.delayReason || 'Unbekannt'}</div>
    </div>`;
  });
  document.getElementById('delayedShipments').innerHTML = delHtml || 'Keine verz√∂gerten Sendungen ‚úÖ';
}

function renderInquiries(searchTerm = '') {
  let filtered = inquiries;
  if (currentInquiryFilter !== 'all') filtered = filtered.filter(i => i.status === currentInquiryFilter);
  if (searchTerm) { const s = searchTerm.toLowerCase(); filtered = filtered.filter(i => (i.customer+i.country+i.number).toLowerCase().includes(s)); }

  document.getElementById('inquiryTableBody').innerHTML = filtered.map(i => `<tr>
    <td><strong>${i.number}</strong></td>
    <td>${formatDate(i.createdAt)}</td>
    <td>${i.customer}</td>
    <td>${i.country}</td>
    <td>${i.incoterm}</td>
    <td>${i.transport==='sea'?'üö¢ See':i.transport==='air'?'‚úàÔ∏è Luft':'üöõ Stra√üe'}${i.dg?' ‚ö†Ô∏è':''}</td>
    <td><span class="markup-display">${i.markupPercent||30}%</span></td>
    <td>${formatCurrency(i.costPrice)}</td>
    <td><strong>${formatCurrency(i.sellPrice)}</strong></td>
    <td>${getStatusBadge(i.status)}</td>
    <td>
      <button class="btn btn-sm btn-outline" onclick="openInquiryModal('${i.id}')">‚úèÔ∏è</button>
      ${i.status==='open'?`<button class="btn btn-sm btn-warning" onclick="updateInquiryStatus('${i.id}','quoted')">Angeboten</button>`:''}
      ${i.status==='quoted'?`<button class="btn btn-sm btn-success" onclick="convertToShipment('${i.id}')">‚Üí Sendung</button>`:''}
      <button class="btn btn-sm btn-danger" onclick="deleteInquiry('${i.id}')">üóëÔ∏è</button>
    </td>
  </tr>`).join('');
}

function filterInquiryStatus(status, el) {
  currentInquiryFilter = status;
  document.querySelectorAll('#inquiryTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderInquiries();
}
function filterInquiries(v) { renderInquiries(v); }

function renderShipments(searchTerm = '') {
  let filtered = shipments;
  if (currentShipmentFilter !== 'all') filtered = filtered.filter(s => s.status === currentShipmentFilter);
  if (searchTerm) { const t = searchTerm.toLowerCase(); filtered = filtered.filter(s => (s.customer+s.country+s.number).toLowerCase().includes(t)); }

  document.getElementById('shipmentTableBody').innerHTML = filtered.map(s => {
    const done = s.workflowSteps ? s.workflowSteps.filter(st => st.done).length : 0;
    const total = s.workflowSteps ? s.workflowSteps.length : 0;
    const pct = total ? Math.round(done/total*100) : 0;
    return `<tr>
      <td><strong>${s.number}</strong></td>
      <td>${s.customer}</td>
      <td>${s.country}</td>
      <td>${s.incoterm}</td>
      <td>${s.transport==='sea'?'üö¢':s.transport==='air'?'‚úàÔ∏è':'üöõ'}${s.dg?' ‚ö†Ô∏è':''}</td>
      <td>${formatDate(s.etdDate)}</td>
      <td>${formatDate(s.etaDate)}</td>
      <td><span class="markup-display">${s.freightMarkup||30}%</span></td>
      <td>${getStatusBadge(s.status)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:5px">
          <div style="flex:1;background:#eee;border-radius:4px;height:6px;min-width:60px"><div style="width:${pct}%;background:var(--secondary);height:100%;border-radius:4px"></div></div>
          <span style="font-size:10px">${pct}%</span>
        </div>
      </td>
      <td style="white-space:nowrap">
        <button class="btn btn-sm btn-outline" onclick="openWorkflow('${s.id}')">üìã</button>
        <button class="btn btn-sm btn-outline" onclick="openShipmentModal('${s.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-outline" onclick="openTrackingModal('${s.id}')">üìç</button>
        ${s.status==='in_progress'?`<button class="btn btn-sm btn-warning" onclick="updateShipmentStatus('${s.id}','shipped')">üö¢</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteShipment('${s.id}')">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

function filterShipmentStatus(status, el) {
  currentShipmentFilter = status;
  document.querySelectorAll('#shipmentTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderShipments();
}
function filterShipments(v) { renderShipments(v); }

function renderTracking() {
  let filtered = shipments.filter(s => !['EXW','FCA'].includes(s.incoterm));
  if (currentTrackingFilter !== 'all') filtered = filtered.filter(s => s.tracking?.status === currentTrackingFilter);

  document.getElementById('trackingTableBody').innerHTML = filtered.map(s => {
    const t = s.tracking || {};
    let deviation = '-';
    if (t.actualETA && s.etaDate) {
      const d = daysBetween(s.etaDate, t.actualETA);
      deviation = d > 0 ? `<span class="deviation-pos">+${d}d</span>` : d < 0 ? `<span class="deviation-neg">${d}d</span>` : '‚úÖ 0d';
    }
    return `<tr>
      <td><strong>${s.number}</strong></td>
      <td>${s.customer}</td>
      <td>${s.country}</td>
      <td>${s.transport==='sea'?'üö¢':s.transport==='air'?'‚úàÔ∏è':'üöõ'}</td>
      <td>${t.vessel || '-'}</td>
      <td>${formatDate(s.etdDate)}</td>
      <td>${formatDate(s.etaDate)}</td>
      <td>${t.actualETD ? formatDate(t.actualETD) : '-'}</td>
      <td>${t.actualETA ? formatDate(t.actualETA) : '-'}</td>
      <td>${deviation}</td>
      <td>${getStatusBadge(t.status || 'booked')}</td>
      <td><button class="btn btn-sm btn-primary" onclick="openTrackingModal('${s.id}')">üìç Update</button></td>
    </tr>`;
  }).join('');
}

function filterTrackingStatus(status, el) {
  currentTrackingFilter = status;
  document.querySelectorAll('#trackingTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderTracking();
}

function renderInvoices() {
  let filtered = shipments;
  if (currentInvoiceFilter === 'due') filtered = filtered.filter(s => !s.invoiceCreatedDate && !isInvoiceMonthOverdue(s) && getInvoiceDeadlineMonth(s));
  else if (currentInvoiceFilter === 'overdue') filtered = filtered.filter(s => isInvoiceMonthOverdue(s));
  else if (currentInvoiceFilter === 'done') filtered = filtered.filter(s => s.invoiceCreatedDate);

  document.getElementById('invoiceTableBody').innerHTML = filtered.map(s => {
    const deadline = getInvoiceDeadlineMonth(s);
    const overdue = isInvoiceMonthOverdue(s);
    const triggerLabel = s.tracking?.deliveredDate ? 'Lieferung' : s.tracking?.actualETA ? 'Akt. ETA' : s.etaDate ? 'Plan ETA' : s.goodsDispatchedDate ? 'Versand' : '-';
    return `<tr style="${overdue?'background:#fff5f5':''}">
      <td><strong>${s.number}</strong></td>
      <td>${s.customer}</td>
      <td>${s.country}</td>
      <td>${deadline ? getMonthName(deadline.getMonth()) + ' ' + deadline.getFullYear() : '-'}</td>
      <td>${triggerLabel}</td>
      <td>${s.invoiceCreatedDate ? formatDate(s.invoiceCreatedDate) : '-'}</td>
      <td>${s.invoiceCreatedDate ? '<span class="status-badge status-completed">Erledigt</span>' : overdue ? '<span class="status-badge status-delayed">√úberf√§llig!</span>' : '<span class="status-badge status-new">Offen</span>'}</td>
      <td>${!s.invoiceCreatedDate ? `<button class="btn btn-sm btn-success" onclick="markInvoiceCreated('${s.id}')">‚úì RE erstellt</button>` : ''}</td>
    </tr>`;
  }).join('');
}

function filterInvoiceStatus(status, el) {
  currentInvoiceFilter = status;
  document.querySelectorAll('#invoiceTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderInvoices();
}

function renderCountries(searchTerm = '') {
  let filtered = countries;
  if (searchTerm) { const s = searchTerm.toLowerCase(); filtered = filtered.filter(c => (c.name+c.code).toLowerCase().includes(s)); }
  document.getElementById('countryTableBody').innerHTML = filtered.map(c => `<tr>
    <td><strong>${c.name}</strong></td><td>${c.code}</td>
    <td>${c.port}</td><td>${c.airport}</td>
    <td>${c.transitSea}</td><td>${c.transitAir}</td>
    <td><span class="${getRiskClass(c.risk)}">${c.risk.toUpperCase()}</span></td>
    <td><span class="${getRiskClass(c.payRisk)}">${c.payRisk.toUpperCase()}</span></td>
    <td>${c.logistics}</td><td>${c.language}</td>
    <td>${c.specialCert || '-'}</td><td>${c.recommended}</td>
  </tr>`).join('');
}
function filterCountries(v) { renderCountries(v); }

function renderDocuments(searchTerm = '') {
  let filtered = documents;
  if (searchTerm) { const s = searchTerm.toLowerCase(); filtered = filtered.filter(d => (d.en+d.fr).toLowerCase().includes(s)); }
  document.getElementById('documentTableBody').innerHTML = filtered.map(d => `<tr>
    <td><strong>${d.en}</strong></td><td>${d.fr}</td>
    <td>${d.mandatory?'‚úÖ Ja':'‚ùå Nein'}</td><td>${d.lc?'‚úÖ':'‚ùå'}</td>
    <td>${d.days}</td><td>${d.cost}</td><td>${d.issuer}</td><td style="font-size:11px">${d.notes}</td>
  </tr>`).join('');
}
function filterDocuments(v) { renderDocuments(v); }

function renderTemplates(searchTerm = '') {
  let filtered = emailTemplates;
  if (searchTerm) { const s = searchTerm.toLowerCase(); filtered = filtered.filter(t => (t.title+t.cat).toLowerCase().includes(s)); }
  document.getElementById('templateList').innerHTML = filtered.map(t => `
    <div class="email-template" onclick="copyTemplate('${t.id}')">
      <h4>${t.title} <span style="font-size:10px;color:var(--text-light);font-weight:normal">[${t.cat}]</span></h4>
      <p>${t.text.substring(0,120)}...</p>
    </div>
  `).join('');
}
function filterTemplates(v) { renderTemplates(v); }

function copyTemplate(id) {
  const t = emailTemplates.find(t => t.id === id);
  if (t) { navigator.clipboard.writeText(t.text); showCopyFeedback(); }
}

function renderNotifications() {
  const html = notifications.map(n => `
    <div class="notification-item ${n.read?'':'unread'}" onclick="markNotifRead('${n.id}')">
      ${n.read?'':'<div class="notif-dot"></div>'}
      <div><div style="font-size:12px">${n.text}</div><div style="font-size:10px;color:var(--text-light)">${formatDate(n.date)}</div></div>
    </div>
  `).join('');
  document.getElementById('notificationList').innerHTML = html || 'Keine Benachrichtigungen';
}

function markNotifRead(id) {
  const n = notifications.find(n => n.id === id);
  if (n) { n.read = true; save(); renderNotifications(); updateBadges(); }
}

function clearNotifications() {
  notifications = []; save(); renderNotifications(); updateBadges();
}

// ============================================================
// ANALYTICS
// ============================================================
function renderAnalytics() {
  const total = shipments.length;
  const active = shipments.filter(s => s.status !== 'delivered').length;
  const delayed = shipments.filter(s => s.tracking?.status === 'delayed');
  const avgDelay = delayed.length ? Math.round(delayed.reduce((sum, s) => {
    const d = s.tracking?.actualETA && s.etaDate ? daysBetween(s.etaDate, s.tracking.actualETA) : 0;
    return sum + Math.max(0, d);
  }, 0) / delayed.length) : 0;
  const overdue = shipments.filter(s => isInvoiceMonthOverdue(s)).length;
  const pending = shipments.filter(s => s.workflowSteps?.some(st => !st.done) && s.status !== 'delivered').length;

  document.getElementById('analyticsKPIs').innerHTML = `
    <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Sendungen gesamt</div></div>
    <div class="stat-card green"><div class="stat-value">${active}</div><div class="stat-label">Aktiv</div></div>
    <div class="stat-card red"><div class="stat-value">${delayed.length}</div><div class="stat-label">Verz√∂gert (√ò ${avgDelay}d)</div></div>
    <div class="stat-card orange"><div class="stat-value">${overdue}</div><div class="stat-label">RE √ºberf√§llig</div></div>
    <div class="stat-card"><div class="stat-value">${pending}</div><div class="stat-label">Offene Workflows</div></div>
  `;

  // Transport chart
  const transCount = { sea: 0, air: 0, road: 0 };
  shipments.forEach(s => transCount[s.transport] = (transCount[s.transport]||0) + 1);
  renderBarChart('transportChart', { 'üö¢ See': transCount.sea, '‚úàÔ∏è Luft': transCount.air, 'üöõ Stra√üe': transCount.road });

  // Incoterm chart
  const iCount = {};
  shipments.forEach(s => iCount[s.incoterm] = (iCount[s.incoterm]||0) + 1);
  renderBarChart('incotermChart', iCount);

  // Delay reasons
  const dReasons = {};
  delayed.forEach(s => { const r = s.tracking?.delayReason || 'unknown'; dReasons[r] = (dReasons[r]||0) + 1; });
  const reasonLabels = { port_congestion:'Hafenstau', weather:'Wetter', customs:'Zoll', documentation:'Dokumente', vessel_delay:'Schiff', other:'Sonstiges', unknown:'Unbekannt' };
  const rData = {};
  Object.keys(dReasons).forEach(k => rData[reasonLabels[k]||k] = dReasons[k]);
  renderBarChart('delayChart', rData);

  // Invoice analysis
  const invByMonth = {};
  shipments.forEach(s => {
    const d = getInvoiceDeadlineMonth(s);
    if (d) {
      const key = getMonthName(d.getMonth()) + ' ' + d.getFullYear();
      if (!invByMonth[key]) invByMonth[key] = { total: 0, done: 0, overdue: 0 };
      invByMonth[key].total++;
      if (s.invoiceCreatedDate) invByMonth[key].done++;
      if (isInvoiceMonthOverdue(s)) invByMonth[key].overdue++;
    }
  });
  let invHtml = '<table><thead><tr><th>Monat</th><th>Gesamt</th><th>Erledigt</th><th>√úberf√§llig</th></tr></thead><tbody>';
  Object.keys(invByMonth).forEach(k => {
    const m = invByMonth[k];
    invHtml += `<tr><td>${k}</td><td>${m.total}</td><td>${m.done}</td><td style="color:${m.overdue?'var(--danger)':'inherit'}">${m.overdue}</td></tr>`;
  });
  invHtml += '</tbody></table>';
  document.getElementById('invoiceAnalysis').innerHTML = Object.keys(invByMonth).length ? invHtml : '<p style="font-size:12px;color:var(--text-light)">Keine Rechnungsdaten</p>';

  // Critical activities
  let critHtml = '';
  shipments.filter(s => s.dg && s.status !== 'delivered').forEach(s => {
    critHtml += `<div style="padding:6px 0;font-size:12px;border-bottom:1px solid #eee">‚ö†Ô∏è <strong>DG Sendung:</strong> ${s.number} ${s.customer} ‚Üí ${s.country}</div>`;
  });
  shipments.filter(s => isInvoiceMonthOverdue(s)).forEach(s => {
    critHtml += `<div style="padding:6px 0;font-size:12px;border-bottom:1px solid #eee">üí∞ <strong>RE √ºberf√§llig:</strong> ${s.number} ${s.customer}</div>`;
  });
  delayed.forEach(s => {
    critHtml += `<div style="padding:6px 0;font-size:12px;border-bottom:1px solid #eee">üî¥ <strong>Verz√∂gert:</strong> ${s.number} ${s.customer} ‚Üí ${s.country}</div>`;
  });
  document.getElementById('criticalActivities').innerHTML = critHtml || '<p style="font-size:12px;color:var(--text-light)">Keine kritischen Aktivit√§ten ‚úÖ</p>';
}

function renderBarChart(containerId, data) {
  const container = document.getElementById(containerId);
  const max = Math.max(...Object.values(data), 1);
  container.innerHTML = Object.entries(data).map(([label, val]) => `
    <div class="bar-item">
      <div class="bar-value">${val}</div>
      <div class="bar" style="height:${(val/max)*100}px"></div>
      <div class="bar-label" title="${label}">${label}</div>
    </div>
  `).join('');
}

// ============================================================
// EXPORT / IMPORT
// ============================================================
function exportData() {
  const data = { version: 'V7', date: new Date().toISOString(), inquiries, shipments, notifications };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ExportAfrika_V7_Backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.inquiries) inquiries = data.inquiries;
      if (data.shipments) shipments = data.shipments;
      if (data.notifications) notifications = data.notifications;
      save();
      alert('Daten erfolgreich importiert!');
      switchView('dashboard');
      updateBadges();
    } catch(err) { alert('Fehler beim Import: ' + err.message); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ============================================================
// AUTO-REMINDERS (every 30 min)
// ============================================================
function checkReminders() {
  // DG Label 24h warning
  shipments.forEach(s => {
    if (s.dg && s.etdDate && s.status !== 'delivered') {
      const hoursUntil = (new Date(s.etdDate) - new Date()) / 3600000;
      if (hoursUntil > 0 && hoursUntil < 24) {
        const exists = notifications.find(n => n.text.includes(s.number) && n.text.includes('DG Label') && daysBetween(n.date, new Date()) < 1);
        if (!exists) addNotification(`‚ö†Ô∏è DG Label pr√ºfen: ${s.number} - ETD in ${Math.round(hoursUntil)}h!`, 'warning');
      }
    }
  });
  // Overdue invoices
  shipments.forEach(s => {
    if (isInvoiceMonthOverdue(s)) {
      const exists = notifications.find(n => n.text.includes(s.number) && n.text.includes('Rechnung') && daysBetween(n.date, new Date()) < 1);
      if (!exists) addNotification(`üí∞ Rechnung √ºberf√§llig: ${s.number} ${s.customer}`, 'warning');
    }
  });
  updateBadges();
}

// ============================================================
// INIT
// ============================================================
function init() {
  renderDashboard();
  updateBadges();
  checkReminders();
  setInterval(checkReminders, 1800000); // 30 min
}

init();
</script>
</body>
</html>
